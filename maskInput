<input id="phone" type="text" placeholder="+7 (___)-___-__-__" maxlength="18">
<script>
document.addEventListener('DOMContentLoaded', function () {
    const phoneInput = document.getElementById('phone');
    const maskTemplate = '+7 (___)-___-__-__';

    phoneInput.addEventListener('focus', applyMask);
    phoneInput.addEventListener('input', handleInput);
    phoneInput.addEventListener('keydown', handleBackspace);

    // Применяем маску при фокусе
    function applyMask() {
        if (!phoneInput.value || phoneInput.value === maskTemplate) {
            phoneInput.value = maskTemplate;
            setCaretPosition(phoneInput, maskTemplate.indexOf('_'));
        }
    }

    // Обработка ввода
    function handleInput(event) {
        const input = phoneInput.value.replace(/\D/g, ''); // Убираем все, кроме цифр
        let formattedValue = maskTemplate;
        let index = 0;

        // Перебираем цифры и вставляем их в маску
        for (let char of input) {
            if (formattedValue.indexOf('_') === -1) break; // Маска заполнена
            if (index === 0 && char === '8') continue; // Запрещаем 8 первой цифрой в скобках
            formattedValue = formattedValue.replace('_', char);
            index++;
        }

        phoneInput.value = formattedValue;

        // Устанавливаем каретку после последнего введенного символа
        setCaretPosition(phoneInput, formattedValue.indexOf('_') !== -1 ? formattedValue.indexOf('_') : formattedValue.length);
    }

    // Обработка удаления символов
    function handleBackspace(event) {
        if (event.key === 'Backspace') {
            event.preventDefault();

            let start = phoneInput.selectionStart;
            let end = phoneInput.selectionEnd;

            // Удаляем один символ перед кареткой
            if (start === end && start > 0) {
                while (start > 0 && maskTemplate[start - 1] !== '_') {
                    start--;
                }
                const valueArray = phoneInput.value.split('');
                valueArray[start - 1] = '_'; // Возвращаем подчеркивание
                phoneInput.value = valueArray.join('');
                setCaretPosition(phoneInput, start - 1);
            }
        }
    }

    // Устанавливаем позицию каретки
    function setCaretPosition(elem, pos) {
        elem.setSelectionRange(pos, pos);
    }
});
</script>
