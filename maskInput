<input id="phone" type="text" placeholder="+7 (___)-___-__-__" maxlength="18">
<script>
document.addEventListener('DOMContentLoaded', function () {
    const phoneInput = document.getElementById('phone');
    const maskTemplate = '+7 (___)-___-__-__';

    phoneInput.addEventListener('focus', applyMask);
    phoneInput.addEventListener('input', handleInput);
    phoneInput.addEventListener('keydown', handleBackspace);

    // Применяем маску при фокусе
    function applyMask() {
        if (!phoneInput.value || phoneInput.value === maskTemplate) {
            phoneInput.value = maskTemplate;
            setCaretPosition(phoneInput, maskTemplate.indexOf('_'));
        }
    }

    // Обработка ввода
    function handleInput(event) {
        let input = phoneInput.value.replace(/\D/g, ''); // Убираем все, кроме цифр
        const caretPos = phoneInput.selectionStart;
        const maskArray = maskTemplate.split('');
        let index = 0;

        // Перебираем цифры и вставляем их в маску
        for (let i = 0; i < maskArray.length; i++) {
            if (index >= input.length) break;
            if (maskArray[i] === '_') {
                if (i === 4 && input[index] === '8') continue; // Запрещаем 8 первой цифрой в скобках
                maskArray[i] = input[index++];
            }
        }

        // Сохраняем формат маски
        phoneInput.value = maskArray.join('');
        setCaretPosition(phoneInput, caretPos);
    }

    // Обработка удаления символов
    function handleBackspace(event) {
        if (event.key === 'Backspace') {
            event.preventDefault();
            const start = phoneInput.selectionStart;

            // Удаляем символ перед кареткой
            if (start > 0) {
                const valueArray = phoneInput.value.split('');
                for (let i = start - 1; i >= 0; i--) {
                    if (maskTemplate[i] === '_') {
                        valueArray[i] = '_';
                        phoneInput.value = valueArray.join('');
                        setCaretPosition(phoneInput, i);
                        break;
                    }
                }
            }
        }
    }

    // Устанавливаем позицию каретки
    function setCaretPosition(elem, pos) {
        setTimeout(() => elem.setSelectionRange(pos, pos), 0);
    }
});
</script>
